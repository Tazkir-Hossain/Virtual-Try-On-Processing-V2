<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fashion Inpainting App</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        color: white;
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .step {
        margin-bottom: 30px;
        opacity: 0.5;
        transition: all 0.3s ease;
      }

      .step.active {
        opacity: 1;
      }

      .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .step-number {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
      }

      .step h3 {
        color: #333;
        font-size: 1.2rem;
      }

      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f9f9f9;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: #e6f0ff;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3rem;
        color: #ccc;
        margin-bottom: 15px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .image-display {
        text-align: center;
        margin: 20px 0;
      }

      .image-display img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .clothing-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .clothing-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .clothing-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
      }

      .clothing-item.selected {
        border-color: #667eea;
        background: #e6f0ff;
      }

      .region-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 8px;
      }

      .region-upper {
        background: #d4edda;
        color: #155724;
      }

      .region-lower {
        background: #d1ecf1;
        color: #0c5460;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .range-group {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .range-group input[type="range"] {
        flex: 1;
      }

      .range-value {
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 4px;
        min-width: 40px;
        text-align: center;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .result-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }

      .result-comparison img {
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .credits-info {
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        margin-top: 10px;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .result-comparison {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Fashion Inpainting App</h1>
        <p>Transform your clothing with AI-powered image editing</p>
      </div>

      <!-- Step 1: Upload Image -->
      <div class="card">
        <div class="step active" id="step1">
          <div class="step-header">
            <div class="step-number">1</div>
            <h3>Upload Your Image</h3>
          </div>

          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“¸</div>
            <p>
              <strong>Click to upload</strong> or drag and drop your image here
            </p>
            <p style="color: #666; margin-top: 10px">
              Supported formats: JPG, PNG (Max: 10MB)
            </p>
          </div>

          <input
            type="file"
            id="fileInput"
            accept="image/*"
            style="display: none"
          />

          <div id="uploadedImage" class="image-display hidden"></div>

          <div style="text-align: center; margin-top: 20px">
            <button class="btn" id="detectBtn" disabled>
              Detect Clothing Items
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2: Select Clothing -->
      <div class="card">
        <div class="step" id="step2">
          <div class="step-header">
            <div class="step-number">2</div>
            <h3>Select Clothing Item to Edit</h3>
          </div>

          <div id="detectionResults" class="hidden">
            <div class="image-display">
              <img id="annotatedImage" alt="Detected clothing items" />
            </div>

            <div id="clothingItems" class="clothing-items"></div>

            <div style="text-align: center; margin-top: 20px">
              <button class="btn" id="generateMaskBtn" disabled>
                Generate Mask
              </button>
            </div>
          </div>

          <div id="detectionLoading" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>Detecting clothing items...</p>
          </div>
        </div>
      </div>

      <!-- Step 3: Review Mask -->
      <div class="card">
        <div class="step" id="step3">
          <div class="step-header">
            <div class="step-number">3</div>
            <h3>Review Generated Mask</h3>
          </div>

          <div id="maskResults" class="hidden">
            <div class="image-display">
              <img id="maskImage" alt="Generated mask" />
            </div>

            <div style="text-align: center; margin-top: 20px">
              <button class="btn btn-secondary" id="regenerateMaskBtn">
                Regenerate Mask
              </button>
              <button class="btn" id="proceedToInpaintBtn">
                Proceed to Inpainting
              </button>
            </div>
          </div>

          <div id="maskLoading" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>Generating segmentation mask...</p>
          </div>
        </div>
      </div>

      <!-- Step 4: Inpainting -->
      <div class="card">
        <div class="step" id="step4">
          <div class="step-header">
            <div class="step-number">4</div>
            <h3>Customize Your Design</h3>
          </div>

          <div id="inpaintingForm" class="hidden">
            <div class="form-group">
              <label for="promptInput"
                >What would you like to change it to?</label
              >
              <input
                type="text"
                id="promptInput"
                placeholder="e.g., bright blue jeans, red dress, white shirt"
              />
            </div>

            <div class="form-group">
              <label for="negativePromptInput">What to avoid (optional)</label>
              <input
                type="text"
                id="negativePromptInput"
                placeholder="e.g., dark colors, patterns, wrinkles"
              />
            </div>

            <div class="form-group">
              <label for="strengthRange"
                >Transformation Strength:
                <span id="strengthValue">0.8</span></label
              >
              <div class="range-group">
                <input
                  type="range"
                  id="strengthRange"
                  min="0.3"
                  max="1.0"
                  step="0.1"
                  value="0.8"
                />
                <div class="range-value">
                  <span>0.8</span>
                </div>
              </div>
              <small style="color: #666"
                >Lower values = subtle changes, Higher values = dramatic
                changes</small
              >
            </div>

            <div style="text-align: center; margin-top: 30px">
              <button class="btn" id="inpaintBtn">Generate New Design</button>
            </div>
          </div>

          <div id="inpaintingLoading" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>Creating your new design...</p>
            <p style="font-size: 0.9rem; color: #666">
              This may take 30-60 seconds
            </p>
          </div>
        </div>
      </div>

      <!-- Step 5: Results -->
      <div class="card">
        <div class="step" id="step5">
          <div class="step-header">
            <div class="step-number">5</div>
            <h3>Your Result</h3>
          </div>

          <div id="finalResults" class="hidden">
            <div class="result-comparison">
              <div style="text-align: center">
                <h4>Before</h4>
                <img id="beforeImage" alt="Original image" />
              </div>
              <div style="text-align: center">
                <h4>After</h4>
                <img id="afterImage" alt="Generated result" />
              </div>
            </div>

            <div style="text-align: center; margin-top: 20px">
              <button class="btn" id="downloadBtn">Download Result</button>
              <button class="btn btn-secondary" id="startOverBtn">
                Start Over
              </button>
            </div>

            <div id="creditsInfo" class="credits-info hidden"></div>
          </div>
        </div>
      </div>

      <!-- Error Messages -->
      <div id="errorMessage" class="error hidden"></div>
    </div>

    <script>
      // Application State
      let currentStep = 1;
      let uploadedImageData = null;
      let detectedItems = [];
      let selectedItem = null;
      let maskImageData = null;

      // DOM Elements
      const fileInput = document.getElementById("fileInput");
      const uploadArea = document.getElementById("uploadArea");
      const detectBtn = document.getElementById("detectBtn");
      const generateMaskBtn = document.getElementById("generateMaskBtn");
      const regenerateMaskBtn = document.getElementById("regenerateMaskBtn");
      const proceedToInpaintBtn = document.getElementById(
        "proceedToInpaintBtn"
      );
      const inpaintBtn = document.getElementById("inpaintBtn");
      const strengthRange = document.getElementById("strengthRange");
      const strengthValue = document.getElementById("strengthValue");
      const downloadBtn = document.getElementById("downloadBtn");
      const startOverBtn = document.getElementById("startOverBtn");

      // Utility Functions
      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
        setTimeout(() => errorDiv.classList.add("hidden"), 5000);
      }

      function activateStep(stepNumber) {
        document
          .querySelectorAll(".step")
          .forEach((step) => step.classList.remove("active"));
        document.getElementById(`step${stepNumber}`).classList.add("active");
        currentStep = stepNumber;
      }

      function showLoading(loadingId) {
        document.getElementById(loadingId).classList.remove("hidden");
      }

      function hideLoading(loadingId) {
        document.getElementById(loadingId).classList.add("hidden");
      }

      // File Upload Handling
      uploadArea.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });

      function handleFileUpload(file) {
        if (!file.type.startsWith("image/")) {
          showError("Please select an image file");
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          // 10MB limit
          showError("File size must be less than 10MB");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImageData = e.target.result;

          // Display uploaded image
          const uploadedImageDiv = document.getElementById("uploadedImage");
          uploadedImageDiv.innerHTML = `<img src="${uploadedImageData}" alt="Uploaded image" style="max-width: 100%; max-height: 400px;">`;
          uploadedImageDiv.classList.remove("hidden");

          // Enable detect button
          detectBtn.disabled = false;

          // Hide upload area
          uploadArea.style.display = "none";
        };
        reader.readAsDataURL(file);
      }

      // Detection
      detectBtn.addEventListener("click", async () => {
        showLoading("detectionLoading");
        activateStep(2);

        const formData = new FormData();
        const blob = await fetch(uploadedImageData).then((r) => r.blob());
        formData.append("file", blob);

        try {
          const response = await fetch("/detect-clothing/", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          hideLoading("detectionLoading");

          if (result.success) {
            detectedItems = result.detected_items;

            // Display annotated image
            document.getElementById("annotatedImage").src =
              result.annotated_image;

            // Display clothing items
            displayClothingItems(detectedItems);

            document
              .getElementById("detectionResults")
              .classList.remove("hidden");
          } else {
            showError(result.error || "Failed to detect clothing items");
          }
        } catch (error) {
          hideLoading("detectionLoading");
          showError("Network error during detection");
        }
      });

      function displayClothingItems(items) {
        const container = document.getElementById("clothingItems");
        container.innerHTML = "";

        if (items.length === 0) {
          container.innerHTML =
            "<p>No clothing items detected. Please try another image.</p>";
          return;
        }

        items.forEach((item) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "clothing-item";
          itemDiv.innerHTML = `
                    <h4>${item.class}</h4>
                    <span class="region-badge region-${
                      item.region
                    }">${item.region.toUpperCase()}</span>
                    <p>Confidence: ${(item.confidence * 100).toFixed(1)}%</p>
                `;

          itemDiv.addEventListener("click", () =>
            selectClothingItem(item, itemDiv)
          );
          container.appendChild(itemDiv);
        });
      }

      function selectClothingItem(item, element) {
        // Remove previous selection
        document
          .querySelectorAll(".clothing-item")
          .forEach((el) => el.classList.remove("selected"));

        // Select current item
        element.classList.add("selected");
        selectedItem = item;
        generateMaskBtn.disabled = false;
      }

      // Mask Generation
      generateMaskBtn.addEventListener("click", async () => {
        if (!selectedItem) return;

        showLoading("maskLoading");
        activateStep(3);

        try {
          const formData = new FormData();
          formData.append("image_data", uploadedImageData);
          formData.append("selected_item", JSON.stringify(selectedItem));

          const response = await fetch("/generate-mask/", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          hideLoading("maskLoading");

          if (result.success) {
            maskImageData = result.mask_image;
            document.getElementById("maskImage").src = maskImageData;
            document.getElementById("maskResults").classList.remove("hidden");
          } else {
            showError(result.error || "Failed to generate mask");
          }
        } catch (error) {
          hideLoading("maskLoading");
          showError("Network error during mask generation");
        }
      });

      regenerateMaskBtn.addEventListener("click", () => {
        generateMaskBtn.click();
      });

      proceedToInpaintBtn.addEventListener("click", () => {
        activateStep(4);
        document.getElementById("inpaintingForm").classList.remove("hidden");
      });

      // Strength Range
      strengthRange.addEventListener("input", (e) => {
        const value = e.target.value;
        strengthValue.textContent = value;
        document.querySelector(".range-value span").textContent = value;
      });

      // Inpainting
      inpaintBtn.addEventListener("click", async () => {
        const prompt = document.getElementById("promptInput").value.trim();

        if (!prompt) {
          showError("Please enter a description of what you want to change");
          return;
        }

        showLoading("inpaintingLoading");
        activateStep(5);

        const formData = new FormData();
        formData.append("original_image", uploadedImageData);
        formData.append("mask_image", maskImageData);
        formData.append("prompt", prompt);
        formData.append(
          "negative_prompt",
          document.getElementById("negativePromptInput").value
        );
        formData.append("strength", strengthRange.value);

        try {
          const response = await fetch("/inpaint/", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          hideLoading("inpaintingLoading");

          if (result.success) {
            // Display results
            document.getElementById("beforeImage").src = uploadedImageData;
            document.getElementById("afterImage").src = result.result_image;
            document.getElementById("finalResults").classList.remove("hidden");

            // Show credits info
            if (result.credits_remaining) {
              const creditsDiv = document.getElementById("creditsInfo");
              creditsDiv.textContent = `Credits remaining: ${result.credits_remaining}`;
              creditsDiv.classList.remove("hidden");
            }
          } else {
            showError(result.error || "Failed to generate result");
          }
        } catch (error) {
          hideLoading("inpaintingLoading");
          showError("Network error during inpainting");
        }
      });

      // Download Result
      downloadBtn.addEventListener("click", () => {
        const afterImage = document.getElementById("afterImage");
        const link = document.createElement("a");
        link.download = "fashion-inpaint-result.jpg";
        link.href = afterImage.src;
        link.click();
      });

      // Start Over
      startOverBtn.addEventListener("click", () => {
        // Reset all state
        currentStep = 1;
        uploadedImageData = null;
        detectedItems = [];
        selectedItem = null;
        maskImageData = null;

        // Reset UI
        document.getElementById("uploadedImage").classList.add("hidden");
        document.getElementById("detectionResults").classList.add("hidden");
        document.getElementById("maskResults").classList.add("hidden");
        document.getElementById("inpaintingForm").classList.add("hidden");
        document.getElementById("finalResults").classList.add("hidden");

        uploadArea.style.display = "block";
        detectBtn.disabled = true;
        generateMaskBtn.disabled = true;

        // Clear inputs
        document.getElementById("promptInput").value = "";
        document.getElementById("negativePromptInput").value = "";
        fileInput.value = "";

        activateStep(1);
      });

      // Initialize
      activateStep(1);
    </script>
  </body>
</html>
